input {
  http_poller {
   schedule => { every => "5s" }
    urls => {
      test1 => {
        method => get
        url => "http://transformation-service:8001/test1"
        headers => {
          Accept => "application/json"
        }
     }
    }
    codec => json {
      target => "input"
    }
  }
}

filter {
  http{
    verb => "POST" 
    url => "http://transformation-service:8001/full-transform"
    body => {
      "template_miner_ID" => "test"
      "smart_filter_threshold" => 0.5
      "pii_detection_lang" => "en"
      "msg" => "%{[input][msg]}"
    }
    body_format => "json"
    target_body => "meta"
  }
  
  mutate {
    add_field => { "Message" => "%{[input][msg]}"}
    add_field => { "SmartFilter" => "%{[meta][anomaly]}" }
    add_field => { "Template" => "%{[meta][template_ID]}" }
    add_field => { "PII" => "%{[meta][PII]}" }
    remove_field => ["input", "event", "meta"]
  }
}

output {
  mongodb {
    id => "logstash-mongo"
    database => "solution_test"
    collection => "test_1"
    isodate => "true"
    uri => "mongodb://mongo:27017/"
  }
}
